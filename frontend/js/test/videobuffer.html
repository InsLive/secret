<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>VideoBuffer Test</title>
</head>
<body>
<h1>VideoBuffer</h1>
<h2>用于缓存连续的视频片段来避免网络问题可能导致的视频卡顿。</h2>
<p>整个网络中的VideoBuffer基本上是一致的，比如缓存5s视频，那么全网缓存的这5s片段都是大致相同的。</p>
<p>在一个新的节点加入网络后，该节点会试图绑定多个上级节点作为输入源，使用<b>快速装入技术</b>来获得全网相同的5s缓冲。</p>
<p>这时候新节点向所有正在绑定的节点发送同步缓冲请求，所有源节点会<b>先发送他们缓冲中最早的一个片段</b>，然后随机发送所有片段。</p>
<p>多个源随机发送的片段被新节点收到后重组，并行地传输会提高缓冲装入速度。</p>
<p>缓冲区中早于<i>最后一段缓冲视频段的结束时间</i>5s以上的视频段会被刷出播放，但是有一段代码保证快速装载的片段不会被过早释放。</p>
<p>这是为了重组的正确性。</p>
<p>快速装载超过5s的缓存后，进入正常状态，收到视频段后直接装入缓冲。但是如果此时突然失去源，快速装载将再一次被启动。</p>
<p>在快速装载启动时，当前缓冲区的最迟时间点将被记录下来，整个快速装载过程中，<i>最后一段缓冲视频段的结束时间</i>被认为是：</p>
<p>快速装载启动时所经过的时间+当时记录的时间。这样即使在快速装载重新开始后一段时间内没有输入，也会有视频正常播放。</p>
<p><b>注意：</b>缓冲处于正常状态时，只有新压如数据，才会吐出旧数据，所以上层应该及时发现输入流能力不足，并调用fastload。</p>
<script src="../priorityqueue.js"></script>
<script src="../videobuffer.js"></script>
<script>
    var vb = new VideoBuffer();
    vb.onstatechanged = function(state) {
        console.log("state changed to", state);
    };
    vb.ondataready = function(b) {
        console.log("data ready:", b);
    };
    var now = new Date().getTime();

    function assert(b, msg) {
        if (!b) throw msg;
    }

    function Test1() {
        vb.fastload();
        vb.pushVideoSlice(new VideoSlice(now - 6000, now - 5500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 5000, now - 4500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 3000, now - 2500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 2500, now - 2000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 5500, now - 5000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 4500, now - 4000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 3500, now - 3000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 4000, now - 3500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 2000, now - 1500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 1500, now - 1000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 1000, now - 500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now - 500, now - 0, new Uint8Array([1, 2, 3])));
        vb.fastload();
    }

    Test1();
    setTimeout(function() {
        console.log(vb.getBufferedDuration());
        vb.pushVideoSlice(new VideoSlice(now + 0, now + 500, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now + 500, now + 1000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now + 1500, now + 2000, new Uint8Array([1, 2, 3])));
        vb.pushVideoSlice(new VideoSlice(now + 2000, now + 2500, new Uint8Array([1, 2, 3])));
        console.log(vb.getBufferedDuration());
        vb.fastload();
    }, 800);
</script>
</body>
</html>