<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Video Test Page</title>
</head>
<body>
<video id="v" controls autoplay></video>
<script src="../priorityqueue.js"></script>
<script src="../videobuffer.js"></script>
<script src="../video.js"></script>

<script>
    var vb = [];
    vb[0] = new VideoBuffer();
    vb[1] = new VideoBuffer();
    vb[0].onstatechanged = function(state) {
        console.log("state changed to", state);
    };
    vb[0].ondataready = function(b) {
        v.ondata("vp9", b);
    };
    vb[1].onstatechanged = function(state) {
        console.log("state changed to", state);
    };
    vb[1].ondataready = function(b) {
        v.ondata("vorbis", b);
    };

    var v = new Video(document.getElementById("v"));


    function readUint64(data, offset) {
        var ret = 0;
        for (var i = offset; i < offset + 8; i++) {
            ret *= 256;
            ret += data[i];
        }
        return ret;
    }

    var ws = new WebSocket("ws://127.0.0.1:8888/stream/test");
    ws.binaryType = 'arraybuffer';
    var inited = 0;
    ws.onmessage = function(e) {
        // struct msg {
        //     uint32_t dataoffset;
        //     uint64_t createtimestamp;
        //     uint64_t nexttimestamp;
        //     char[]   codec;
        //     ...
        //     uint8_t  videostream;
        // }

        if (inited < 2) {
            var data = new Uint8Array(e.data);
            var offset = data[3];
            vb[inited].fastload();
            vb[inited].ondataready(new Uint8Array(data.slice(offset)));
            inited++;
            return
        }

        var data = new Uint8Array(e.data);
        var offset = data[3];
        var vs = new VideoSlice(
            readUint64(data, 4),
            readUint64(data, 12),
            new Uint8Array(data.slice((data[3])))
        );
        var codec = new TextDecoder("utf-8").decode(data.slice(20, offset));
        if (codec == "vp9")
            vb[0].pushVideoSlice(vs);
        else
            vb[1].pushVideoSlice(vs);
    };

</script>
</body>
</html>